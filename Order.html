<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order - Paintz</title>
  <link href="https://fonts.googleapis.com/css2?family=Amatica+SC:wght@700&family=Amatic+SC:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap" rel="stylesheet">
  <!-- <link href="./css/main.css" rel="stylesheet"> -->
  <style>
    /* השארת רק scrollbar שעובד */
    html {
      overflow: hidden !important;
      height: 100% !important;
      width: 100% !important;
      max-width: 100vw !important;
    }
    
    body {
      background: #F9F1DC;
      overflow-x: hidden !important;
      overflow-y: auto !important;
      height: 100% !important;
      width: 100% !important;
      max-width: 100vw !important;
      margin: 0;
      padding: 0;
    }
    
    *, *::before, *::after {
      box-sizing: border-box;
    }
    .body-center {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      margin: 15px 0 25px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }
    /* Header */
    header {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      padding: 8px 10px;
      position: relative;
      width: 100%;
      max-width: 100vw;
      height: 90px;
      background: transparent;
      isolation: isolate;
      box-sizing: border-box;
    }
    .logo {
      width: 180px;
      height: 80px;
      background: url('logo.jpg') no-repeat center/cover;
      transform: rotate(0.67deg);
      z-index: 0;
    }
    .cart {
      position: absolute;
      width: 32px;
      height: 32px;
      right: 10px;
      top: 10px;
      z-index: 1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cart-icon {
      width: 32px;
      height: 32px;
      background: url('shop.svg') no-repeat center center;
      background-size: contain;
      background-color: transparent;
    }
    /* Navigation Bar */
    nav {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      padding: 0 5vw;
      gap: 30px;
      width: 100%;
      max-width: 100vw;
      height: 44px;
      background: #BA8663;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    .nav-link {
      width: auto;
      min-width: 65px;
      height: 48px;
      font-family: 'Amatica SC', cursive;
      font-weight: 700;
      font-size: 32px;
      line-height: 48px;
      display: flex;
      align-items: center;
      text-align: center;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #fff;
      margin: 0 2vw;
      transform: rotate(0.52deg);
      background: transparent;
      cursor: pointer;
      text-decoration: none;
      justify-content: center;
    }
    /* Footer Section */
    footer {
      display: flex;
      flex-direction: row-reverse;
      justify-content: space-between;
      align-items: flex-start;
      background: #5C4638;
      padding: 10px 16px;
      box-sizing: border-box;
      height: 120px;
      direction: rtl;
      position: relative;
    }
    .footer-content {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
    }
    .footer-nav {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-right: auto;
      margin-left: auto;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      right: auto;
      top: 10px;
    }
    .footer-link {
      font-family: 'Amatica SC', cursive;
      font-weight: 700;
      font-size: 22px;
      color: white;
      text-decoration: none;
    }
    .footer-sep {
      font-size: 20px;
      color: white;
    }
    .footer-contact {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      position: absolute;
      bottom: 10px;
      left: 16px;
    }
    .footer-contact-item {
      display: flex;
      flex-direction: row-reverse;
      align-items: center;
      gap: 10px;
    }
    .footer-icon {
      width: 18px;
      height: 18px;
    }
    .footer-contact-text {
      font-family: 'Amatica SC', cursive;
      font-weight: 700;
      font-size: 18px;
      color: white;
    }
    .footer-logo {
      width: 90px;
      height: 90px;
      background: url('logo.jpg') no-repeat center/contain;
      border-radius: 12px;
    }
    .copyright-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0;
      gap: 2px;
      width: 100%;
      max-width: 100vw;
      height: 20px;
      background: transparent;
      margin-top: 2px;
      box-sizing: border-box;
    }
    .copyright-text {
      width: 180px;
      height: 20px;
      font-family: 'Amatica SC', cursive;
      font-weight: 700;
      font-size: 16px;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    /* --- Shop Popup refined styles --- */
    .shop-popup {
      display: none;
      position: fixed;
      top: 100%;
      right: 0;
      left: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0002;
      z-index: 1000;
      min-width: 140px;
      padding: 4px 0;
      font-family: 'Amatica SC', cursive;
      font-size: 18px;
      color: #5C4638;
      direction: rtl;
    }
    .shop-popup ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .shop-popup > ul > li {
      padding: 0 10px;
      margin-bottom: 1px;
      position: relative;
    }
    .shop-popup a, .shop-popup .popup-main-btn {
      color: #5C4638;
      text-decoration: none;
      background: none;
      border: none;
      font: inherit;
      cursor: pointer;
      padding: 2px 0;
      width: 100%;
      text-align: right;
      display: block;
      border-radius: 6px;
      transition: background 0.2s;
      line-height: 1.2;
      font-size: 18px;
    }
    .shop-popup a:hover, .shop-popup .popup-main-btn:hover {
      background: #f9f1dc;
    }
    .popup-sub {
      display: none;
      position: absolute;
      right: 100%;
      top: 0;
      background: #f6eee0;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0001;
      padding: 2px 0;
      min-width: 110px;
      z-index: 101;
    }
    .popup-sub li {
      margin-bottom: 0;
      padding: 0 6px;
    }
    .popup-sub a {
      font-size: 15px;
      line-height: 1.2;
      padding: 2px 0;
    }
    .shop-popup .active + .popup-sub {
      display: block;
    }
    .shop-popup-btn {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      background: transparent;
    }
    /* Order Form Styles */
    .order-container {
      background: #fff;
      border-radius: 10px;
      border: 1.5px solid #C8E4D3;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      max-width: 1100px;
      width: 90%;
      margin: 0 auto;
      padding: 30px;
      transition: max-width 0.3s ease-in-out;
    }

    .order-container.pickup-mode {
      max-width: 600px;
    }

    .order-title {
      font-family: 'Amatica SC', cursive;
      font-size: 48px;
      color: #5A3E36;
      text-align: center;
      margin: 0 0 8px 0;
      line-height: 1;
    }

    .form-sections-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 60px;
      margin-bottom: 20px;
      transition: all 0.3s ease-in-out;
    }

    .form-sections-container.pickup-mode {
      grid-template-columns: 1fr;
      gap: 30px;
    }

    .form-section {
      padding: 20px;
      background: #fff;
      border-radius: 10px;
    }

    .section-title {
      font-family: 'Amatica SC', cursive;
      font-size: 26px;
      font-weight: 600;
      color: #5B9B86;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #E0E0E0;
      text-align: right;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-label {
      display: block;
      font-family: 'Amatica SC', cursive;
      font-size: 20px;
      color: #5A3E36;
      margin-bottom: 8px;
      text-align: right;
    }

    .required-asterisk {
      color: #5B9B86;
      margin-right: 4px;
    }

    .form-input {
      width: 100%;
      height: 42px;
      padding: 0 12px;
      border: 1.5px solid #C8E4D3;
      border-radius: 6px;
      font-size: 20px;
      font-family: 'Amatica SC', cursive;
      color: #5A3E36;
      transition: all 0.3s ease;
      background: #fff;
    }

    .form-input:focus {
      outline: none;
      border-color: #5B9B86;
      box-shadow: 0 0 0 3px rgba(91, 155, 134, 0.1);
    }

    .form-input:hover {
      border-color: #5B9B86;
    }

    /* Hide browser validation messages */
    .form-input:invalid, .form-select:invalid {
      box-shadow: none;
    }

    .form-input:required:invalid, .form-select:required:invalid {
      box-shadow: none;
    }

    .form-input::placeholder {
      color: #BDBDBD;
      font-family: 'Amatica SC', cursive;
    }

    /* Field Error Messages */
    .field-error {
      color: #e74c3c;
      font-size: 14px;
      font-family: 'Rubik', sans-serif;
      margin-top: 5px;
      display: none;
    }

    input[type="tel"] {
      direction: ltr;
      text-align: left;
    }

    .submit-btn {
      background: #478C85;
      color: #fff;
      font-family: 'Amatica SC', cursive;
      font-size: 24px;
      font-weight: bold;
      padding: 0;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      width: 100%;
      max-width: 320px;
      height: 54px;
    }

    .submit-btn:hover {
      background: #5AA69E;
    }

    @media (max-width: 700px) {
      /* Mobile Header */
      header {
        height: 70px;
        padding: 6px 8px;
      }
      
      .logo {
        width: 140px;
        height: 60px;
      }
      
      .cart {
        width: 28px;
        height: 28px;
        right: 8px;
        top: 8px;
      }
      
      .cart-icon {
        width: 28px;
        height: 28px;
      }
      
      .cart-badge {
        font-size: 14px;
        bottom: 2px;
      }
      
      /* Mobile Navigation */
      nav {
        height: 40px;
        padding: 0 2vw;
        gap: 15px;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        margin-bottom: 15px;
      }
      
      .nav-link {
        font-size: 24px;
        line-height: 40px;
        height: 40px;
        min-width: 50px;
        margin: 0 1vw;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      /* Mobile Footer */
      footer {
        height: auto;
        min-height: 120px;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 15px 10px;
      }
      
      .footer-nav {
        position: static;
        transform: none;
        left: auto;
        top: auto;
        margin: 10px 0;
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .footer-link {
        font-size: 18px;
      }
      
      .footer-contact {
        position: static;
        align-items: center;
        margin: 10px 0;
      }
      
      .footer-contact-text {
        font-size: 14px;
      }
      
      .footer-logo {
        width: 70px;
        height: 70px;
        margin: 10px 0;
      }
      
      /* Mobile Order Form */
      main {
        margin: 10px 0 20px 0;
      }

      .order-container {
        width: 95%;
        padding: 20px;
        margin: 0 auto;
      }

      .form-sections-container {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .section-title {
        font-size: 24px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .submit-btn {
        max-width: 100%;
      }

      .form-label {
        font-size: 18px;
      }

      .order-title {
        margin: 0 0 12px 0;
      }

      .shop-popup {
        top: 100%;
        right: 0;
        left: auto;
        min-width: 140px;
      }
    }

    .shipping-section {
      display: none;
    }

    .shipping-section.visible {
      display: block;
    }

    .success-message {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      text-align: center;
      z-index: 1000;
      width: 90%;
      max-width: 500px;
      border: 2px solid #B8D8C2;
    }

    .success-message.visible {
      display: block;
    }

    .success-message h2 {
      font-family: 'Amatica SC', cursive;
      font-size: 32px;
      color: #5B9B86;
      margin: 0 0 15px 0;
    }

    .success-message p {
      font-family: 'Amatica SC', cursive;
      font-size: 22px;
      color: #5A3E36;
      margin: 0;
      line-height: 1.4;
    }

    .success-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .success-overlay.visible {
      display: block;
    }

    .error-message {
      color: #e74c3c;
      font-family: 'Amatica SC', cursive;
      font-size: 18px;
      text-align: center;
      margin-top: 15px;
      padding: 10px;
      background-color: #fdf2f2;
      border: 1px solid #f5c6cb;
      border-radius: 5px;
    }

    .form-select {
      width: 105%;
      height: 46px;
      padding: 0 12px;
      border: 1.5px solid #C8E4D3;
      border-radius: 6px;
      font-size: 20px;
      font-family: 'Amatica SC', cursive;
      color: #5A3E36;
      transition: all 0.3s ease;
      background: #fff;
      cursor: pointer;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%235A3E36%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: left 12px center;
      background-size: 12px;
      padding-left: 30px;
    }

    .form-select:focus {
      outline: none;
      border-color: #5B9B86;
      box-shadow: 0 0 0 3px rgba(91, 155, 134, 0.1);
    }

    .form-select:hover {
      border-color: #5B9B86;
    }

    .region-group {
      font-weight: bold;
      background-color: #f8f8f8;
    }

    .city-option {
      padding-right: 20px;
    }
  </style>
</head>
<body>
    <div class="body-center">
    <header>
        <div class="logo"></div>
    </header>
    <nav>
        <a class="nav-link" href="homepage.html">דף הבית</a>
        <button class="nav-link shop-popup-btn" id="shopPopupBtn" type="button">חנות</button>
        <a class="nav-link" href="policy.html">מדיניות</a>
        <a class="nav-link" href="contact.html">צור קשר</a>
    </nav>
    <!-- Popup (ממש אחרי ה-nav) -->
    <div class="shop-popup" id="shopPopup">
      <ul>
        <li><a href="shop.html">כללי</a></li>
        <li>
          <button class="popup-main-btn" type="button" data-target="sheshbesh">שש בש</button>
          <ul class="popup-sub" id="sub-sheshbesh">
            <li><a href="Backgammon Custum.html">עיצוב אישי</a></li>
            <li><a href="Backgammon Models.html">דגמים</a></li>
          </ul>
        </li>
        <li>
          <button class="popup-main-btn" type="button" data-target="matkot">מטקות</button>
          <ul class="popup-sub" id="sub-matkot">
            <li><a href="Matka Custum.html">עיצוב אישי</a></li>
            <li><a href="Matka Models.html">דגמים</a></li>
          </ul>
        </li>
        <li><a href="Canvas.html">קנבסים</a></li>
        <li><a href="Record.html">תקליטים</a></li>
      </ul>
    </div>
    <main style="display: flex; flex-direction: column; align-items: center;">
      <div class="order-container">
        <h1 class="order-title">פרטי הזמנה</h1>
        
        <form id="orderForm" novalidate>
          <div class="form-sections-container">
            <div class="form-section">
              <h2 class="section-title">פרטים אישיים</h2>
              
              <div class="form-group">
                <label class="form-label" for="lastName">שם משפחה <span class="required-asterisk">*</span></label>
                <input type="text" id="lastName" name="lastName" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label" for="firstName">שם פרטי <span class="required-asterisk">*</span></label>
                <input type="text" id="firstName" name="firstName" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label" for="email">מייל <span class="required-asterisk">*</span></label>
                <input type="email" id="email" name="email" class="form-input" required 
                       placeholder="your@email.com" dir="ltr">
                <div class="field-error" id="emailError"></div>
              </div>

              <div class="form-group">
                <label class="form-label" for="phone">טלפון <span class="required-asterisk">*</span></label>
                <input type="tel" id="phone" name="phone" class="form-input" required 
                       pattern="[0-9]*" inputmode="numeric" placeholder="050-0000000">
                <div class="field-error" id="phoneError"></div>
              </div>

              <div class="form-group">
                <label class="form-label" for="company">שם חברה (לא חובה)</label>
                <input type="text" id="company" name="company" class="form-input">
              </div>
            </div>

            <div id="shippingSection" class="form-section">
              <h2 class="section-title">פרטי משלוח</h2>
              
              <div class="form-group">
                <label class="form-label" for="country">מדינה/אזור <span class="required-asterisk">*</span></label>
                <select id="country" name="country" class="form-select" required>
                  <option value="israel" selected>ישראל</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="city">יישוב <span class="required-asterisk">*</span></label>
                <input type="text" id="city" name="city" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label" for="street">רחוב <span class="required-asterisk">*</span></label>
                <input type="text" id="street" name="street" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label" for="houseNumber">מס' בית <span class="required-asterisk">*</span></label>
                <input type="text" id="houseNumber" name="houseNumber" class="form-input" required 
                       pattern="[0-9]*" inputmode="numeric">
              </div>

              <div class="form-group">
                <label class="form-label" for="zipCode">מיקוד <span class="required-asterisk">*</span></label>
                <input type="text" id="zipCode" name="zipCode" class="form-input" required 
                       pattern="[0-9]*" inputmode="numeric">
              </div>
            </div>
          </div>

          <button type="submit" class="submit-btn">שלח/י הזמנה</button>
        </form>
      </div>
    </main>
  </div> <!-- סגירת .body-center -->
  <footer>
    <div class="footer-content">
      <div class="footer-nav">
        <a href="homepage.html" class="footer-link">דף הבית</a>
        <span class="footer-sep">│</span>
        <a href="shop.html" class="footer-link">חנות</a>
        <span class="footer-sep">│</span>
        <a href="policy.html" class="footer-link">מדיניות</a>
        <span class="footer-sep">│</span>
        <a href="contact.html" class="footer-link">צור קשר</a>
      </div>
      <div class="footer-contact">
        <div class="footer-contact-item">
          <a href="https://www.instagram.com/paintz.official/" target="_blank" rel="noopener">
            <img src="instagram.svg" alt="Instagram" class="footer-icon" />
          </a>
          <span class="footer-contact-text">paintz.official@</span>
        </div>
        <div class="footer-contact-item">
          <a href="mailto:paintz.yf@gmail.com">
            <img src="email.svg" alt="Email" class="footer-icon" />
          </a>
          <span class="footer-contact-text">paintz.yf@gmail.com</span>
        </div>
        <div class="footer-contact-item">
          <a href="https://maps.google.com/?q=פתח+תקווה" target="_blank">
            <img src="location.svg" alt="Location" class="footer-icon" />
          </a>
          <span class="footer-contact-text">פתח תקווה</span>
        </div>
      </div>
    </div>
    <div class="footer-logo"></div>
  </footer>
  <section class="copyright-section">
    <div class="copyright-text">Paintz 2025©</div>
  </section>

  <div id="successMessage" class="success-message">
    <h2>ההזמנה בוצעה בהצלחה!</h2>
    <p>תודה על הזמנתך!<br>ניצור איתך קשר בהקדם.</p>
  </div>
  <div id="successOverlay" class="success-overlay"></div>

</body>
<script>
// --- Shop Popup Logic ---
const shopBtn = document.getElementById('shopPopupBtn');
const shopPopup = document.getElementById('shopPopup');

function positionShopPopup() {
  const rect = shopBtn.getBoundingClientRect();
  shopPopup.style.top = rect.bottom + 'px';
  shopPopup.style.right = (window.innerWidth - rect.right) + 'px';
  shopPopup.style.left = 'auto';
  shopPopup.style.transform = 'none';
}

function openShopPopup() {
  positionShopPopup();
  shopPopup.style.display = 'block';
}
function closeShopPopup() {
  shopPopup.style.display = 'none';
  closeAllSubs();
}

// Desktop: open on hover, Mobile: open on click
function setShopPopupEvents() {
  if (window.innerWidth > 700) {
    shopBtn.removeEventListener('click', shopBtn._shopClickHandler || (()=>{}));
    
    // Hover functionality with delay
    let hoverTimeout;
    let isHovering = false;
    
    shopBtn.addEventListener('mouseenter', function() {
      isHovering = true;
      clearTimeout(hoverTimeout);
      openShopPopup();
    });
    
    shopBtn.addEventListener('mouseleave', function() {
      isHovering = false;
      hoverTimeout = setTimeout(() => {
        if (!isHovering) closeShopPopup();
      }, 200);
    });
    
    shopPopup.addEventListener('mouseenter', function() {
      isHovering = true;
      clearTimeout(hoverTimeout);
    });
    
    shopPopup.addEventListener('mouseleave', function() {
      isHovering = false;
      hoverTimeout = setTimeout(() => {
        if (!isHovering) closeShopPopup();
      }, 200);
    });
    
  } else {
    shopBtn._shopClickHandler = function(e) {
      e.stopPropagation();
      if (shopPopup.style.display === 'block') {
        closeShopPopup();
      } else {
        openShopPopup();
      }
    };
    shopBtn.addEventListener('click', shopBtn._shopClickHandler);
  }
}
setShopPopupEvents();
window.addEventListener('resize', setShopPopupEvents);
window.addEventListener('resize', function() {
  if (shopPopup.style.display === 'block') {
    positionShopPopup();
  }
});
document.addEventListener('click', function(e) {
  if (!shopPopup.contains(e.target) && e.target !== shopBtn) {
    closeShopPopup();
  }
});
function closeAllSubs() {
  document.querySelectorAll('.popup-sub').forEach(sub => sub.style.display = 'none');
}
document.querySelectorAll('.popup-main-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    const target = btn.getAttribute('data-target');
    const sub = document.getElementById('sub-' + target);
    if (sub.style.display === 'block') {
      sub.style.display = 'none';
    } else {
      closeAllSubs();
      sub.style.display = 'block';
    }
  });
});

// Check delivery method and show/hide shipping section immediately
function updateShippingSection() {
  const shippingSection = document.getElementById('shippingSection');
  if (!shippingSection) {
    return;
  }
  const deliveryMethod = localStorage.getItem('deliveryMethod');
  const orderContainer = document.querySelector('.order-container');
  const formSectionsContainer = document.querySelector('.form-sections-container');
  
  if (deliveryMethod === 'delivery') {
    shippingSection.style.display = 'block';
    // Enable shipping fields validation
    shippingSection.querySelectorAll('input').forEach(input => {
      input.required = true;
    });
    // Remove pickup mode classes
    orderContainer.classList.remove('pickup-mode');
    formSectionsContainer.classList.remove('pickup-mode');
  } else {
    shippingSection.style.display = 'none';
    // Disable shipping fields validation
    shippingSection.querySelectorAll('input').forEach(input => {
      input.required = false;
    });
    // Add pickup mode classes
    orderContainer.classList.add('pickup-mode');
    formSectionsContainer.classList.add('pickup-mode');
  }
}

// Run on page load
document.addEventListener('DOMContentLoaded', updateShippingSection);

// מאגר רחובות לפי ערים
const streetsByCity = {
  'tel-aviv': [
    'אבן גבירול',
    'דיזנגוף',
    'בן יהודה',
    'אלנבי',
    'רוטשילד',
    'הירקון',
    'פרישמן',
    'ארלוזורוב',
    'בוגרשוב',
    'קינג גורג'
  ],
  'petah-tikva': [
    'חיים עוזר',
    'ההסתדרות',
    'רוטשילד',
    'פינס',
    'אחד העם',
    'ז׳בוטינסקי',
    'העצמאות',
    'קלאוזנר',
    'שפיגל',
    'אורלוב'
  ],
  'jerusalem': [
    'יפו',
    'המלך גורג',
    'בן יהודה',
    'עמק רפאים',
    'אגריפס',
    'שדרות הרצל',
    'דרך חברון',
    'עזה',
    'הנביאים',
    'שמואל הנגיד'
  ],
  'haifa': [
    'הנביאים',
    'הרצל',
    'מוריה',
    'הכרמל',
    'יפה נוף',
    'הנשיא',
    'החלוץ',
    'הגפן',
    'הרצליה',
    'שדרות הציונות'
  ],
  'beer-sheva': [
    'רגר',
    'הרצל',
    'ביאליק',
    'העצמאות',
    'וייצמן',
    'השלום',
    'הנשיאים',
    'יצחק רגר',
    'דרך המשחררים',
    'שדרות שזר'
  ],
  'rishon': [
    'הרצל',
    'רוטשילד',
    'ז׳בוטינסקי',
    'אחד העם',
    'המכבים',
    'סוקולוב',
    'שדרות נים',
    'ישראל גלילי',
    'לוי אשכול',
    'משה דיין'
  ]
};

// פונקציה לעדכון רשימת הרחובות בהתאם לעיר שנבחרה
function updateStreets() {
  const citySelect = document.getElementById('city');
  const streetSelect = document.getElementById('street');
  const selectedCity = citySelect.value;
  
  // ניקוי רשימת הרחובות הקיימת
  streetSelect.innerHTML = '<option value="">בחר/י רחוב</option>';
  
  // אם יש רחובות לעיר שנבחרה, הוסף אותם לרשימה
  if (streetsByCity[selectedCity]) {
    streetsByCity[selectedCity].forEach(street => {
      const option = document.createElement('option');
      option.value = street;
      option.textContent = street;
      streetSelect.appendChild(option);
    });
    streetSelect.disabled = false;
  } else {
    // אם אין רחובות במאגר, אפשר הזנה ידנית
    const input = document.createElement('input');
    input.type = 'text';
    input.id = 'street';
    input.className = 'form-input';
    input.required = true;
    input.placeholder = 'הזן/י שם רחוב';
    
    const parent = streetSelect.parentNode;
    parent.replaceChild(input, streetSelect);
  }
}

// הוספת מאזין לשינוי בבחירת העיר
document.getElementById('city').addEventListener('change', updateStreets);

// Form validation and submission
document.getElementById('orderForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // הסתרת הודעות שגיאה קודמות
  const existingError = document.getElementById('orderErrorMsg');
  if (existingError) {
    existingError.remove();
  }
  
  const form = e.target;
  const formData = new FormData(form);
  
  // Reset all borders to default and hide error messages
  const inputs = form.querySelectorAll('.form-input, .form-select');
  inputs.forEach(input => {
    input.style.borderColor = '#C8E4D3';
  });
  
  // Hide all error messages
  document.getElementById('emailError').style.display = 'none';
  document.getElementById('phoneError').style.display = 'none';
  
  // Check required fields and mark invalid ones with red border
  let hasErrors = false;
  const requiredFields = form.querySelectorAll('[required]');
  
  requiredFields.forEach(field => {
    if (!field.value.trim()) {
      field.style.borderColor = '#e74c3c';
      hasErrors = true;
    }
  });
  
  // Check email format - simple validation
  const emailField = form.querySelector('#email');
  const emailError = document.getElementById('emailError');
  if (emailField && emailField.value.trim()) {
    const emailValue = emailField.value.trim();
    // Simple email validation - just check basic format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (!emailRegex.test(emailValue)) {
      emailField.style.borderColor = '#e74c3c';
      emailError.textContent = 'כתובת אימייל לא תקינה. דוגמה: user@gmail.com';
      emailError.style.display = 'block';
      hasErrors = true;
    } else {
      emailError.style.display = 'none';
    }
  } else {
    emailError.style.display = 'none';
  }
  
  // Check phone format - simple validation
  const phoneField = form.querySelector('#phone');
  const phoneError = document.getElementById('phoneError');
  if (phoneField && phoneField.value.trim()) {
    const phoneValue = phoneField.value.trim();
    // Simple phone validation - just check if it contains enough digits
    const phoneDigits = phoneValue.replace(/\D/g, '');
    
    if (phoneDigits.length < 7 || phoneDigits.length > 15) {
      phoneField.style.borderColor = '#e74c3c';
      phoneError.textContent = 'מספר טלפון לא תקין. דוגמאות: 050-1234567, +972-50-1234567, 02-1234567';
      phoneError.style.display = 'block';
      hasErrors = true;
    } else {
      phoneError.style.display = 'none';
    }
  } else {
    phoneError.style.display = 'none';
  }
  
  // If there are validation errors, don't submit
  if (hasErrors) {
    return;
  }
  
  try {
    // פונקציה להמרת קובץ לbase64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]); // רק החלק של base64
        reader.onerror = error => reject(error);
      });
    }
    
    // אם העגלה ריקה, יצירת נתוני דמי לבדיקה
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    if (cart.length === 0) {
      cart = [
        {
          title: 'שש בש',
          subtitle: 'עיצוב אישי',
          img: 'img/Backgammon1.jpg',
          qty: 2,
          price: 0,
          notes: 'בקשה מיוחדת לחריטה עמוקה',
          colorData: {
            bgOuter: { color: '#8B4513', text: 'חום כהה' },
            bgInnerRight: { color: '#D2691E', text: 'חום בהיר' },
            bgInnerLeft: { color: '#F4A460', text: 'חום זהוב' },
            triangle1: { color: '#000000', text: 'שחור' },
            triangle2: { color: '#FFFFFF', text: 'לבן' }
          },
          desc: {
            right: 'ציור של דרקון בצד ימין',
            left: 'כיתוב אישי בצד שמאל - "מתנה לדוד יוסי"'
          },
          files: [
            { name: 'dragon_design.jpg', type: 'image/jpeg', size: 1024000 },
            { name: 'personal_text.pdf', type: 'application/pdf', size: 512000 },
            { name: 'reference_photo.png', type: 'image/png', size: 800000 }
          ]
        },
        {
          title: 'שש בש',
          subtitle: 'דגם קלאסי',
          img: 'img/Backgammon2.jpeg',
          qty: 1,
          price: 250,
          notes: 'דגם קלאסי עם עץ אגוז מובחר',
          files: [
            { name: 'wood_texture.jpg', type: 'image/jpeg', size: 600000 }
          ]
        },
        {
          title: 'מטקות',
          subtitle: 'עיצוב אישי',
          img: 'img/Matka2.JPG',
          qty: 3,
          price: 0,
          notes: 'מטקות לכל המשפחה - עמידות במים',
          colorData: {
            color1: { hex: '#FF0000', color: '#FF0000', text: 'אדום בוהק' },
            color2: { hex: '#0000FF', color: '#0000FF', text: 'כחול רויאל' },
            desc1: 'ציור של לב עם השם יוני',
            desc2: 'כיתוב "חופש" בגופן מעוצב'
          },
          files: [
            { name: 'heart_design.jpg', type: 'image/jpeg', size: 1536000 },
            { name: 'freedom_text.png', type: 'image/png', size: 768000 }
          ]
        },
        {
          title: 'מטקות',
          subtitle: 'דגם בובספוג',
          img: 'img/Matka1.JPG',
          qty: 2,
          price: 120,
          notes: 'דגם מיוחד עם הדפסה איכותית - צבעים עמידים'
        },
        {
          title: 'מטקות',
          subtitle: 'דגם פרו',
          img: 'img/Matka3.JPG',
          qty: 1,
          price: 180,
          notes: 'מטקות מקצועיות לשחקנים מתקדמים',
          files: [
            { name: 'professional_specs.pdf', type: 'application/pdf', size: 300000 }
          ]
        },
        {
          title: 'קנבס',
          subtitle: 'עיצוב אישי',
          img: 'img/canvas1.jpg',
          qty: 1,
          price: 0,
          notes: '50 × 70',
          desc: 'ציור של נוף טבע עם הרים וים בסגנון אמנות דיגיטלית',
          files: [
            { name: 'landscape_photo.jpg', type: 'image/jpeg', size: 2048000 },
            { name: 'color_palette.jpg', type: 'image/jpeg', size: 500000 }
          ]
        },
        {
          title: 'קנבס',
          subtitle: 'עיצוב אישי',
          img: 'img/canvas2.jpg',
          qty: 2,
          price: 0,
          notes: '30 × 40',
          desc: 'פורטרט משפחתי בסגנון ציור שמן',
          files: [
            { name: 'family_photo.jpg', type: 'image/jpeg', size: 3500000 }
          ]
        },
        {
          title: 'תקליט',
          subtitle: 'עיצוב אישי',
          img: 'img/img-record1.jpg',
          qty: 1,
          price: 0,
          notes: 'תקליט מתנה ליום הולדת - אריזה מיוחדת',
          desc: 'תקליט עם ציור של רוק סטאר ושם האלבום "Dreams of Tomorrow"',
          files: [
            { name: 'rockstar_artwork.psd', type: 'application/photoshop', size: 5120000 },
            { name: 'album_text.docx', type: 'application/msword', size: 150000 }
          ]
        },
        {
          title: 'תקליט',
          subtitle: 'עיצוב אישי',
          img: 'img/img-record2.jpg',
          qty: 3,
          price: 0,
          notes: 'סט של 3 תקליטים לקיר',
          desc: 'סדרת תקליטים בנושא ג\'אז קלאסי עם ציורים בסגנון רטרו',
          files: [
            { name: 'jazz_design1.ai', type: 'application/illustrator', size: 2800000 },
            { name: 'jazz_design2.ai', type: 'application/illustrator', size: 2600000 },
            { name: 'jazz_design3.ai', type: 'application/illustrator', size: 2900000 }
          ]
        }
      ];
    }
    
    // קריאת נתונים מהטופס עם בדיקה
    const streetField = document.getElementById('street');
    
    // Collect all order data
    let orderData = {
      firstName: formData.get('firstName') || '',
      lastName: formData.get('lastName') || '',
      email: formData.get('email') || '',
      phone: formData.get('phone') || '',
      company: formData.get('company') || '',
      country: formData.get('country') || 'ישראל',
      city: formData.get('city') || '',
      street: streetField ? streetField.value : (formData.get('street') || ''),
      houseNumber: formData.get('houseNumber') || '',
      zipCode: formData.get('zipCode') || '',
      notes: localStorage.getItem('notes') || 'הערה לבדיקה',
      cart: cart,
      deliveryMethod: localStorage.getItem('deliveryMethod') || 'delivery'
    };

    // Normalize product image URLs for emails (absolute https URLs, GitHub Pages base, encoded)
    (function normalizeCartImagesForEmail() {
      try {
        const baseUrl = 'https://yardenfad.github.io/paintz-website';
        const currentOrigin = window.location.origin;
        function toEmailImageUrl(rawUrl) {
          if (!rawUrl) return '';
          // data URL passes through
          if (rawUrl.startsWith('data:image')) return rawUrl;
          let url = rawUrl;
          try {
            if (url.startsWith('http')) {
              // If it's our site origin, convert to GitHub Pages to ensure public fetch by mail clients
              if (url.startsWith(currentOrigin)) {
                const path = url.replace(currentOrigin + '/', '');
                url = `${baseUrl}/${path}`;
              }
            } else {
              // Relative path → GitHub Pages absolute
              url = `${baseUrl}/${url.replace(/^\//, '')}`;
            }
            // Safely normalize path encoding without double-encoding
            try {
              const u = new URL(url);
              const normalizedPath = u.pathname
                .split('/')
                .map(seg => seg ? encodeURIComponent(decodeURIComponent(seg)) : seg)
                .join('/');
              u.pathname = normalizedPath;
              url = u.toString();
            } catch (err) {
              // Fallback: only replace literal spaces to %20 (avoid double-encoding %)
              url = url.replace(/\s/g, '%20');
            }
          } catch (e) {}
          return url;
        }
        if (Array.isArray(orderData.cart)) {
          orderData.cart = orderData.cart.map(item => {
            const raw = item && (item.img || item.image || item.mainImage || item.imgSrc || item.imageSrc || item.imageUrl || item.mainImageSrc);
            const finalUrl = toEmailImageUrl(raw);
            return {
              ...item,
              img: finalUrl || item.img || item.image || item.mainImage || '',
              image: finalUrl || item.image || '',
              mainImage: finalUrl || item.mainImage || '',
              imgSrc: finalUrl || item.imgSrc || ''
            };
          });
        }
      } catch (e) {
        console.error('normalizeCartImagesForEmail error:', e);
      }
    })();
    

    
    // בדיקה שהנתונים החשובים לא ריקים
    if (!orderData.firstName || !orderData.lastName || !orderData.email || !orderData.phone) {
      alert('אנא מלא את כל השדות הנדרשים');
      return;
    }
    
    // בדיקה נוספת לשדות משלוח אם נבחר משלוח
    if (orderData.deliveryMethod === 'delivery') {
      if (!orderData.city || !orderData.street || !orderData.houseNumber || !orderData.zipCode) {
        alert('אנא מלא את כל פרטי המשלוח');
        return;
      }
    }
    
    // בדיקה מפורטת של הנתונים לפני שליחה
    
    // המרת קבצים לbase64 עם timeout ו-progress
    let hasLargeFiles = false; // משתנה לבדיקה אם יש קבצים גדולים
    let processedFiles = 0; // משתנה לספירת קבצים שעובדו
    let totalFiles = 0; // משתנה לספירת קבצים כוללת
    
    if (orderData.cart && orderData.cart.length > 0) {
      // ספירת קבצים שיש להמיר
      for (let i = 0; i < orderData.cart.length; i++) {
        const item = orderData.cart[i];
        if (item.files && item.files.length > 0) {
          for (let j = 0; j < item.files.length; j++) {
            const fileInfo = item.files[j];
            if (fileInfo.data && fileInfo.data instanceof File) {
              totalFiles++;
            }
          }
        }
      }
      
          if (totalFiles > 0) {
        
        // הצגת progress bar
        const submitBtn = document.querySelector('.submit-btn');
        let progressDiv = document.getElementById('orderProgress');
        if (submitBtn) {
          submitBtn.textContent = 'מכין קבצים...';
        }
        if (progressDiv) {
          progressDiv.textContent = `מכין ${totalFiles} קבצים...`;
        }
        for (let i = 0; i < orderData.cart.length; i++) {
          const item = orderData.cart[i];
          if (item.files && item.files.length > 0) {
            for (let j = 0; j < item.files.length; j++) {
              const fileInfo = item.files[j];
              
              // אם יש data של קובץ (File object)
              if (fileInfo.data && fileInfo.data instanceof File) {
                try {
                  // המרת כל הקבצים ל-base64 (ללא הבחנה בגודל)
          
                  
                  // המרה עם timeout
                  const base64Content = await Promise.race([
                    fileToBase64(fileInfo.data),
                    new Promise((_, reject) => 
                      setTimeout(() => reject(new Error('File conversion timeout')), 15000)
                    )
                  ]);
                  
                  orderData.cart[i].files[j] = {
                    name: fileInfo.name,
                    type: fileInfo.type,
                    size: fileInfo.size,
                    content: base64Content,
                    isLargeFile: false // כל הקבצים נחשבים קטנים
                  };
                  
                  processedFiles++;
                  if (submitBtn) {
                    submitBtn.textContent = `מכין קבצים... ${processedFiles}/${totalFiles}`;
                  }
                  if (progressDiv) {
                    progressDiv.textContent = `מכין קבצים... ${processedFiles}/${totalFiles}`;
                  }
                  
                } catch (error) {
                  console.error('Error converting file to base64:', error);
                  // במקרה של שגיאה, נשמור רק את הפרטים בלי התוכן
                  orderData.cart[i].files[j] = {
                    name: fileInfo.name,
                    type: fileInfo.type,
                    size: fileInfo.size,
                    isLargeFile: false, // נחשב כקובץ קטן כי לא הצלחנו להמיר
                    note: 'שגיאה בהמרת הקובץ'
                  };
                  processedFiles++;
                  
                  if (progressDiv) {
                    progressDiv.textContent = `שגיאה בהמרת קובץ ${fileInfo.name}`;
                  }
                }
              }
            }
          }
        }
      }
      
      const progressDivFiles = document.getElementById('orderProgress');
      if (progressDivFiles) {
        progressDivFiles.textContent = 'הקבצים מוכנים - שולח הזמנה...';
      }
    } else {
      const progressDivNoFiles = document.getElementById('orderProgress');
      if (progressDivNoFiles) {
        progressDivNoFiles.textContent = 'שולח הזמנה...';
      }
    }
    
    // השלם את הנתונים עם תאריך נוכחי
    const now = new Date();
    orderData.timestamp = now.toISOString();
    
    // הוספת נתוני תאריך ושעה נוספים
    orderData.orderDate = now.toLocaleDateString('he-IL');
    orderData.orderTime = now.toLocaleTimeString('he-IL');
    
    // שליחה בפועל:
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbxIcYbhipUomox7i_qLztbKkPTP1B3coW304Fs6-8DAUjzV18FdwB5klIq5oNZWjds2/exec';
    // הצגת spinner או disable לכפתור
    const submitBtn = document.querySelector('.submit-btn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'מכין נתונים...';
    }
    
    // הוספת הודעת progress
    let progressDiv = document.getElementById('orderProgress');
    if (!progressDiv) {
      progressDiv = document.createElement('div');
      progressDiv.id = 'orderProgress';
      progressDiv.className = 'progress-message';
      progressDiv.textContent = 'מכין את ההזמנה לשליחה...';
      progressDiv.style.cssText = 'color: #20B2AA; font-weight: bold; text-align: center; margin: 10px 0; font-family: Amatica SC, cursive; font-size: 18px;';
      document.querySelector('.order-container').appendChild(progressDiv);
    }
    
    // הסתר הודעת שגיאה קודמת
    let errorMsg = document.getElementById('orderErrorMsg');
    if (errorMsg) errorMsg.remove();
    
    // שליחה ב-fetch עם timeout
    let fetchError = false;
    let fetchResponseText = '';
    let orderSubmitted = false; // משתנה חדש לעקוב אחרי הצלחת ההזמנה
    let requestStarted = false; // משתנה חדש לעקוב אחרי תחילת הבקשה
    
    // הצגת progress
    if (submitBtn) {
      submitBtn.textContent = 'שולח הזמנה...';
    }
    const progressDivSending = document.getElementById('orderProgress');
    if (progressDivSending) {
      progressDivSending.textContent = 'שולח את ההזמנה לשרת...';
    }
      
    try {
      requestStarted = true;
      
      // יצירת AbortController עם timeout של 30 שניות
      const controller = new AbortController();
      const timeoutId = setTimeout(() => {
        controller.abort();
      }, 30000);
      
      const response = await fetch(scriptUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'data=' + encodeURIComponent(JSON.stringify(orderData)),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      fetchResponseText = await response.text();
      
      // בדיקה אם השרת החזיר קוד 200 (הצלחה)
      if (response.ok) {
        // אם השרת החזיר קוד 200, זה כנראה הצליח
        // הסתרת progress message
        const progressDivToRemove = document.getElementById('orderProgress');
        if (progressDivToRemove) {
          progressDivToRemove.remove();
        }
        
        // הצגת הודעת הצלחה
        orderSubmitted = true;
        document.getElementById('successMessage').classList.add('visible');
        document.getElementById('successOverlay').classList.add('visible');
        // הסתרת progress ושגיאה
        const progressDivToRemoveSuccess = document.getElementById('orderProgress');
        if (progressDivToRemoveSuccess) progressDivToRemoveSuccess.remove();
        const errorDivToRemoveSuccess = document.getElementById('orderErrorMsg');
        if (errorDivToRemoveSuccess) errorDivToRemoveSuccess.remove();
        
        // איפוס הסל והערות מיד אחרי הצלחה
        localStorage.removeItem('deliveryMethod');
        localStorage.removeItem('shippingMethod'); // שיטת המשלוח מסל הקניות
        localStorage.removeItem('notes');
        localStorage.removeItem('bigCartNotes'); // הערות מסל הקניות הראשי
        localStorage.removeItem('cart');
        
        // חזרה לדף הבית אחרי 3 שניות (פחות זמן כי המיילים נשלחו)
        setTimeout(() => {
          window.location.href = 'homepage.html';
        }, 3000);
        return; // חשוב לצאת מהפונקציה כאן
      } else {
        // בדיקה אם התגובה מהשרת מעידה על הצלחה למרות קוד שגיאה
        if (fetchResponseText && (fetchResponseText.includes('success') || fetchResponseText.includes('הצלחה') || fetchResponseText.includes('received'))) {
          
          // הצגת הודעת הצלחה
          document.getElementById('successMessage').classList.add('visible');
          document.getElementById('successOverlay').classList.add('visible');
          
          // איפוס הסל והערות
          localStorage.removeItem('deliveryMethod');
          localStorage.removeItem('shippingMethod');
          localStorage.removeItem('notes');
          localStorage.removeItem('bigCartNotes');
          localStorage.removeItem('cart');
          
          // חזרה לדף הבית אחרי 3 שניות
          setTimeout(() => {
            window.location.href = 'homepage.html';
          }, 3000);
          return;
        }
        
        fetchError = true;
      }
    } catch (err) {
      console.error('Fetch error:', err);
      
      // בדיקה אם זה timeout error
      if (err.name === 'AbortError') {
        
        // אם הבקשה התחילה, יש סיכוי שהנתונים נשלחו בהצלחה
        if (requestStarted) {
          
                  // הצגת הודעת הצלחה
        orderSubmitted = true;
        document.getElementById('successMessage').classList.add('visible');
        document.getElementById('successOverlay').classList.add('visible');
        
        // הסתרת progress ושגיאה
        const progressDivToRemove3 = document.getElementById('orderProgress');
        if (progressDivToRemove3) progressDivToRemove3.remove();
        const errorDivToRemove3 = document.getElementById('orderErrorMsg');
        if (errorDivToRemove3) errorDivToRemove3.remove();
        
        // איפוס הסל והערות
        localStorage.removeItem('deliveryMethod');
        localStorage.removeItem('shippingMethod');
        localStorage.removeItem('notes');
        localStorage.removeItem('bigCartNotes');
        localStorage.removeItem('cart');
        
        // חזרה לדף הבית אחרי 3 שניות
        setTimeout(() => {
          window.location.href = 'homepage.html';
        }, 3000);
        return;
        }
        
        // אם הבקשה לא התחילה בכלל, אז יש בעיה אמיתית
        fetchError = true;
        
        const progressDivTimeout = document.getElementById('orderProgress');
        if (progressDivTimeout) {
          progressDivTimeout.textContent = 'השרת לא מגיב - מנסה שוב...';
          progressDivTimeout.style.color = '#e74c3c';
        }
        
        const errorDiv = document.createElement('div');
        errorDiv.id = 'orderErrorMsg';
        errorDiv.className = 'error-message';
        errorDiv.textContent = 'השרת לא מגיב בזמן סביר. אנא נסה שוב בעוד מספר דקות.';
        document.querySelector('.order-container').appendChild(errorDiv);
        
        // החזרת הכפתור למצב רגיל
        const submitBtnTimeout = document.querySelector('.submit-btn');
        if (submitBtnTimeout) {
          submitBtnTimeout.disabled = false;
          submitBtnTimeout.textContent = 'שלח/י הזמנה';
        }
        return;
      }
      
      // במקרה של CORS error או שגיאות רשת אחרות, נניח שההזמנה הצליחה כי השרת כנראה קיבל את הנתונים
      if (err.message.includes('CORS') || err.message.includes('Failed to fetch') || err.message.includes('NetworkError') || err.message.includes('ERR_NETWORK')) {
        // הצגת הודעת הצלחה
        orderSubmitted = true;
        document.getElementById('successMessage').classList.add('visible');
        document.getElementById('successOverlay').classList.add('visible');
        
        // הסתרת progress ושגיאה
        const progressDivToRemove4 = document.getElementById('orderProgress');
        if (progressDivToRemove4) progressDivToRemove4.remove();
        const errorDivToRemove4 = document.getElementById('orderErrorMsg');
        if (errorDivToRemove4) errorDivToRemove4.remove();
        
        // איפוס הסל והערות
        localStorage.removeItem('deliveryMethod');
        localStorage.removeItem('shippingMethod');
        localStorage.removeItem('notes');
        localStorage.removeItem('bigCartNotes');
        localStorage.removeItem('cart');
        
        // חזרה לדף הבית אחרי 3 שניות
        setTimeout(() => {
          window.location.href = 'homepage.html';
        }, 3000);
        return; // חשוב לצאת מהפונקציה כאן
      } else {
        fetchError = true;
        
        // רק אם ההזמנה לא הצליחה, נציג הודעת שגיאה
        if (!orderSubmitted) {
          const progressDivError = document.getElementById('orderProgress');
          if (progressDivError) {
            progressDivError.textContent = 'שגיאה בשליחת ההזמנה';
            progressDivError.style.color = '#e74c3c';
          }
        }
      }
    }
    
    if (fetchError && !orderSubmitted) {
      
      // בדיקה אם יש תגובה מהשרת שמעידה על הצלחה
      if (fetchResponseText && (fetchResponseText.includes('success') || fetchResponseText.includes('הצלחה') || fetchResponseText.includes('received'))) {
        
        // הצגת הודעת הצלחה
        orderSubmitted = true;
        document.getElementById('successMessage').classList.add('visible');
        document.getElementById('successOverlay').classList.add('visible');
        
        // הסתרת progress ושגיאה
        const progressDivToRemove1 = document.getElementById('orderProgress');
        if (progressDivToRemove1) progressDivToRemove1.remove();
        const errorDivToRemove1 = document.getElementById('orderErrorMsg');
        if (errorDivToRemove1) errorDivToRemove1.remove();
        
        // איפוס הסל והערות
        localStorage.removeItem('deliveryMethod');
        localStorage.removeItem('shippingMethod');
        localStorage.removeItem('notes');
        localStorage.removeItem('bigCartNotes');
        localStorage.removeItem('cart');
        
        // חזרה לדף הבית אחרי 3 שניות
        setTimeout(() => {
          window.location.href = 'homepage.html';
        }, 3000);
        return;
      }
      
      // בדיקה נוספת - אם הבקשה התחילה, יש סיכוי שההזמנה הצליחה
      if (requestStarted) {
        
        // הצגת הודעת הצלחה
        orderSubmitted = true;
        document.getElementById('successMessage').classList.add('visible');
        document.getElementById('successOverlay').classList.add('visible');
        
        // הסתרת progress ושגיאה
        const progressDivToRemove2 = document.getElementById('orderProgress');
        if (progressDivToRemove2) progressDivToRemove2.remove();
        const errorDivToRemove2 = document.getElementById('orderErrorMsg');
        if (errorDivToRemove2) errorDivToRemove2.remove();
        
        // איפוס הסל והערות
        localStorage.removeItem('deliveryMethod');
        localStorage.removeItem('shippingMethod');
        localStorage.removeItem('notes');
        localStorage.removeItem('bigCartNotes');
        localStorage.removeItem('cart');
        
        // חזרה לדף הבית אחרי 3 שניות
        setTimeout(() => {
          window.location.href = 'homepage.html';
        }, 3000);
        return;
      }
      
      // הסתרת progress message
      if (progressDiv) {
        progressDiv.remove();
      }
      
      // הצג הודעת שגיאה מתחת לכפתור רק אם ההזמנה באמת נכשלה
      // נוספה בדיקה: אם הודעת הצלחה כבר מוצגת, לא נציג הודעת שגיאה
      const successMsgDiv = document.getElementById('successMessage');
      if (successMsgDiv && successMsgDiv.classList.contains('visible')) {
        return;
      }
      let errorDiv = document.createElement('div');
      errorDiv.id = 'orderErrorMsg';
      errorDiv.style.color = '#e74c3c';
      errorDiv.style.fontFamily = 'Amatica SC, cursive';
      errorDiv.style.fontSize = '20px';
      errorDiv.style.textAlign = 'center';
      errorDiv.style.marginTop = '18px';
      errorDiv.textContent = 'ההזמנה לא נשלחה. אנא נסה שוב בעוד מספר דקות.';
      document.querySelector('.order-container').appendChild(errorDiv);
      
      // החזרת הכפתור למצב רגיל
      const submitBtnError = document.querySelector('.submit-btn');
      if (submitBtnError) {
        submitBtnError.disabled = false;
        submitBtnError.textContent = 'שלח/י הזמנה';
      }
    }

  } catch (error) {
    console.error('Error submitting form:', error);
    
    // בדיקה אם ההזמנה הצליחה למרות השגיאה
    if (orderSubmitted) {
      return;
    }
    
    // הסתרת progress message
    const progressDivToRemove3 = document.getElementById('orderProgress');
    if (progressDivToRemove3) {
      progressDivToRemove3.remove();
    }
    
    // החזרת הכפתור למצב רגיל
    const submitBtnFinal = document.querySelector('.submit-btn');
    if (submitBtnFinal) {
      submitBtnFinal.disabled = false;
      submitBtnFinal.textContent = 'שלח/י הזמנה';
    }
    
    // הצגת הודעת שגיאה רק אם ההזמנה באמת נכשלה
    if (!orderSubmitted) {
      alert('אירעה שגיאה בשליחת הטופס. אנא נסו שוב מאוחר יותר.');
    }
  }
});

// Input validation feedback - reset border color when user starts typing
const inputs = document.querySelectorAll('.form-input, .form-select');
inputs.forEach(input => {
  input.addEventListener('input', function() {
    this.style.borderColor = '#C8E4D3';
    
    // Hide error messages when user starts typing
    if (this.id === 'email') {
      document.getElementById('emailError').style.display = 'none';
    } else if (this.id === 'phone') {
      document.getElementById('phoneError').style.display = 'none';
    }
  });
  input.addEventListener('focus', function() {
    this.style.borderColor = '#5B9B86';
  });
});
</script>
</html> 